@{
    Layout = null;
}

<!DOCTYPE html>

<html>

<head>

    <base href="../../admin/">

    <partial name="~/Views/Shared/_Init.cshtml" />

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
    <script>
        WebFont.load({
            google: {
                "families": ["Poppins:300,400,500,600,700", "Roboto:300,400,500,600,700"]
            },
            active: function () {
                sessionStorage.fonts = true;
            }
        });
    </script>

    <meta name="viewport" content="">

    <link href="./vendors/general/sweetalert2/dist/sweetalert2.css" rel="stylesheet" type="text/css" />
    <link href="./vendors/general/select2/dist/css/select2.css" rel="stylesheet" type="text/css" />
    <link href="./vendors/general/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet" type="text/css" />
    <link href="./vendors/general/dropify/css/dropify.css" rel="stylesheet" />
    <link href="./vendors/custom/datatables/datatables.bundle.css" rel="stylesheet" type="text/css" />
    <link href="./vendors/noty/notyf.min.css" rel="stylesheet" />
    <link href="./vendors/air-datepicker-master/css/datepicker.css" rel="stylesheet" />
    <link href="./vendors/general/bootstrap-select/dist/css/bootstrap-select.css" rel="stylesheet" type="text/css">
    <link href="./vendors/general/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet" type="text/css">
    <link href="./vendors/bootstrap-datetime-picker/css/bootstrap-datetimepicker.css" rel="stylesheet" />
    <link href="./vendors/tags/bootstrap-tagsinput.css" rel="stylesheet" />
    <link href="./vendors/bootstrap4-editable/css/bootstrap-editable.css" rel="stylesheet" />

    <link href="./vendors/custom/vendors/flaticon/flaticon.css" rel="stylesheet" type="text/css" />
    <link href="./vendors/custom/vendors/flaticon2/flaticon.css" rel="stylesheet" type="text/css" />
    <link href="./vendors/custom/vendors/line-awesome/css/line-awesome.css" rel="stylesheet" type="text/css" />
    <link href="./vendors/general/fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />

    <link href="./css/demo1/style.bundle.css" rel="stylesheet" type="text/css" />

    <link href="./css/demo1/skins/header/base/light.css" rel="stylesheet" type="text/css" />
    <link href="./css/demo1/skins/header/menu/light.css" rel="stylesheet" type="text/css" />
    <link href="./css/demo1/skins/brand/dark.css" rel="stylesheet" type="text/css" />
    <link href="./css/demo1/skins/aside/dark.css" rel="stylesheet" type="text/css" />

    <link href="./css/style.css?v=1.1" rel="stylesheet" />
    <link href="./css/hover.css" rel="stylesheet" />

    <style>
        .bootstrap-tagsinput .tag {
            color: #fffffe;
            background-color: #5867dd;
            padding: 2px 7px;
        }

        .bootstrap-tagsinput {
            display: block;
            width: 100%;
            height: calc(1.5em + 1.3rem + 2px);
            padding: 0.65rem 1rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            border: 1px solid #e2e5ec;
            border-radius: 4px;
        }

        .kt-error_container .kt-error_title > h1 {
            font-size: 3rem;
            font-weight: 700;
            color: #314DA7;
            -webkit-text-stroke-color: white;
        }

        .kt-error_container .kt-error_subtitle {
            font-size: 2rem;
            font-weight: 700;
            color: #6c7293;
        }

        .kt-error_container .kt-error_description {
            font-size: 1.3rem;
            font-weight: 500;
            line-height: 130%;
            color: #a7abc3;
        }

        .rowRepeater .filter-option-inner-inner {
            font-size: .8rem;
            line-height: 1.6rem;
        }
    </style>

    @RenderSection("styles", required: false)

</head>

<body class="kt-quick-panel--right kt-demo-panel--right kt-offcanvas-panel--right kt-header--fixed kt-header-mobile--fixed kt-subheader--fixed
      kt-subheader--enabled kt-subheader--solid kt-aside--enabled kt-aside--fixed kt-page--loading">

    <div id="kt_scrolltop" class="kt-scrolltop">
        <i class="fa fa-arrow-up"></i>
    </div>

    <div class="modal fade" id="modal_nuevo" role="dialog" aria-labelledby="title_modal_nuevo" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <form>
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="title_modal_nuevo"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="kt-scroll" data-scroll="true" data-height="550">

                            <div id="content_modal_nuevo" class="col-md-12" style="position: relative; height: 100%" >


                            </div>

                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" id="btn_modal_cerrar">Cerrar</button>
                        <button type="button" class="btn btn-primary" id="btn_modal_nuevo">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <partial name="~/Views/Shared/Admin/_HeaderMobile.cshtml" />

    <div class="kt-grid kt-grid--hor kt-grid--root">

        <div class="kt-grid__item kt-grid__item--fluid kt-grid kt-grid--ver kt-page">

            <partial name="~/Views/Shared/Admin/_LeftMenu.cshtml" />

            <div class="kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor kt-wrapper" id="kt_wrapper">

                <partial name="~/Views/Shared/Admin/_HeaderWeb.cshtml" />

                <div class="kt-grid__item kt-grid__item--fluid kt-grid kt-grid--hor">

                    @RenderBody()

                </div>

            </div>

        </div>

    </div>

    <script>
        var KTAppOptions = {
            "colors": {
                "state": {
                    "brand": "#5d78ff",
                    "dark": "#282a3c",
                    "light": "#ffffff",
                    "primary": "#5867dd",
                    "success": "#34bfa3",
                    "info": "#36a3f7",
                    "warning": "#ffb822",
                    "danger": "#fd3995"
                },
                "base": {
                    "label": ["#c5cbe3", "#a1a8c3", "#3d4465", "#3e4466"],
                    "shape": ["#f0f3ff", "#d9dffa", "#afb4d4", "#646c9a"]
                }
            }
        };
    </script>

    <script src="./vendors/general/jquery/dist/jquery.js" type="text/javascript"></script>
    <script src="./vendors/general/popper.js/dist/umd/popper.js" type="text/javascript"></script>
    <script src="./vendors/general/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="./vendors/general/js-cookie/src/js.cookie.js" type="text/javascript"></script>
    <script src="./vendors/general/perfect-scrollbar/dist/perfect-scrollbar.js" type="text/javascript"></script>
    <script src="./vendors/general/sticky-js/dist/sticky.min.js" type="text/javascript"></script>
    <script src="./vendors/general/block-ui/jquery.blockUI.js" type="text/javascript"></script>
    <script src="./vendors/general/jquery.repeater/jquery.repeater.js"></script>
    <script src="./vendors/general/bootstrap-select/dist/js/bootstrap-select.js" type="text/javascript"></script>
    <script src="./vendors/general/moment/min/moment.min.js" type="text/javascript"></script>
    <script src="./vendors/general/bootstrap-daterangepicker/daterangepicker.js" type="text/javascript"></script>
    <script src="./vendors/bootstrap-datetime-picker/js/bootstrap-datetimepicker.js"></script>
    <script src="./vendors/tags/bootstrap-tagsinput.js"></script>
    <script src="./vendors/bootstrap4-editable/js/bootstrap-editable.js"></script>

    <script src="./vendors/general/sweetalert2/dist/sweetalert2.min.js" type="text/javascript"></script>
    <script src="./vendors/custom/js/vendors/sweetalert2.init.js" type="text/javascript"></script>

    <link href="./vendors/custom/vendors/line-awesome/css/line-awesome.css" rel="stylesheet" type="text/css" />
    <link href="./vendors/general/fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />

    <script src="./vendors/general/select2/dist/js/select2.full.js" type="text/javascript"></script>
    <script src="./vendors/general/dropify/js/dropify.js"></script>
    <script src="./vendors/noty/notyf.min.js"></script>
    <script src="./vendors/air-datepicker-master/js/datepicker.js"></script>

    <script src="./js/demo1/scripts.bundle.js" type="text/javascript"></script>

    <script src="./vendors/custom/datatables/datatables.bundle.js" type="text/javascript"></script>

    <script>

        const notyf = new Notyf({
            duration: 5000,
            dismissible: true,
            position: {
                x: 'center',
                y: 'bottom',
            }
        });

        var urlCreate;
        var urlEdit;
        var urlDelete;

        var errorMessage = function (mensaje) {
            notyf.error(mensaje);
        }

        var successMessage = function (mensaje) {
            notyf.success(mensaje);
        }

        function Eliminar(btn) {

            console.log("Eliminar");

            var current = btn.closest("tr");

            swal.fire({
                title: "Esta seguro?",
                text: "Se eliminara este registro",
                type: 'warning',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                confirmButtonText: 'Aceptar'
            }).then(function (result) {
                if (result.value) {

                    $.get(urlDelete, {id: btn.data("id")}, function (result) {

                        if (result.success)
                        {
                            tabla.row(current).remove().draw(false);
                            successMessage(result.message);
                        }
                        else {
                            formError(btn, result.message);
                        }

                    });

                }
            });

        }

        function Editar(btn) {

            debugger;

            console.log("Editar");

            KTApp.block('.modal-body', {});

            var current = btn.closest("tr");

            $("#title_modal_nuevo").html("Editar");
            $("#btn_modal_nuevo").show();
            $("#btn_modal_nuevo_2").show();
            
            

            $.get(urlEdit, { id: btn.data("id") }, function (result) {

                $('#content_modal_nuevo').html(result);

                InitModal();                

                $('#btn_modal_nuevo').unbind('click').click(function (e) {

                    e.preventDefault();

                    btn = $(this);

                    btn.attr('disabled', true);

                    var form = btn.closest("form");
                    $.validator.unobtrusive.parse(form[0]);
                    var _data = new FormData(form[0]);                 

                    if (!form.valid()) {
                        formError(btn, "Algunos datos no son correctos");
                        return;
                    }

                    KTApp.block('.modal-body', {});

                    $.ajax({
                        url: urlEdit,
                        type: "POST",
                        data: _data,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function (result) {
                            if (result.success) {
                                $('#modal_nuevo').modal('toggle');
                                successMessage(result.message);
                                tabla.row(current).data(result.data);
                            }
                            else {
                                formError(btn, result.message);
                            }
                            return;
                        },
                        error: function (xhr, textStatus) {
                            formError(btn, "Algunos datos no son correctos");
                            return;
                        }
                    });

                });

                $('#btn_modal_nuevo_2').unbind('click').click(function (e) {
                                      

                    e.preventDefault();

                    btn = $(this);

                    btn.attr('disabled', true);

                    var form = btn.closest("form");
                    $.validator.unobtrusive.parse(form[0]);
                    var _data = new FormData(form[0]);                 

                    if (!form.valid()) {
                        formError(btn, "Algunos datos no son correctos");
                        return;
                    }

                    KTApp.block('.modal-body', {});

                    $.ajax({
                        url: "/Admin/GuardarComo",
                        type: "POST",
                        data: _data,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function (result) {
                            if (result.success) {
                                $('#modal_nuevo').modal('toggle');
                                successMessage(result.message);
                                tabla.row.add(result.data).draw(false);;
                            }
                            else {
                                formError(btn, result.message);
                            }
                            return;
                        },
                        error: function (xhr, textStatus) {
                            formError(btn, "Algunos datos no son correctos");
                            return;
                        }
                    });

                });

                }).fail(function (xhr, status, error) {
                errorMessage("Ups.. Surgio un error inesperado");
                return;
            });
        }

        
        function Cambiar(btn) {

            console.log("Cambiar");

            var current = btn.closest("tr");

            $.get(urlCambiar, { id: btn.data("id") }, function (result) {
                if (result.success) {
                    successMessage(result.message);
                    tabla.row(current).data(result.data);
                } else {
                    errorMessage(result.message)
                }
            }).fail(function (xhr, status, error) {
                errorMessage("Ups.. Surgio un error inesperado");
                return;
            });
        }

        $('#btn_crear').on('click', function (e) {

            console.log("Create");

            KTApp.block('.modal-body', {});

            $("#title_modal_nuevo").html("Nuevo");
            $("#btn_modal_nuevo").show();
            

            $.get(urlCreate, {}, function (result) {

                $('#content_modal_nuevo').html(result);
                             
                InitModal();

                $("#btn_modal_nuevo_2").hide();

                $('#btn_modal_nuevo').unbind('click').click(function (e) {

                    e.preventDefault();

                    var btn = $(this);
                    btn.attr('disabled', true);

                    var form = $(this).closest("form");
                    $.validator.unobtrusive.parse(form[0]);
                    var _data = new FormData(form[0]);

                    if (!form.valid()) {
                        formError(btn, "Algunos datos no son correctos");
                        return;
                    }

                    KTApp.block('.modal-body', {});

                    $.ajax({
                        url: urlCreate,
                        type: "POST",
                        data: _data,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function (result) {
                            if (result.success) {
                                $('#modal_nuevo').modal('toggle');
                                successMessage(result.message);
                                tabla.row.add(result.data).draw(false);

                                if (result.editar) {

                                    setTimeout(function () {
                                        $("a.edit[data-id='" + result.id + "']").click();
                                    }, 1000);

                                }
                            }
                            else {
                                formError(btn, result.message);
                            }
                            return;
                        },
                        error: function (xhr, textStatus) {
                            formError(btn, "Algunos datos no son correctos");
                            return;
                        }
                    });

                });
            

            }).fail(function (xhr, status, error) {
                errorMessage("Ups.. Surgio un error inesperado");
                return;
            });

        });

        var formError = function (btn, message) {
            $(".input-validation-error").addClass("is-invalid");
            $(".input-validation-error").first().focus();
            errorMessage(message);
            btn.attr('disabled', false);
            KTApp.unblock('.modal-body');
        }

        function InitModal() {

            console.log("InitModal");

            $('.tags').each(function () {

                $(this).tagsinput();

            });

            $('.select2Simple').each(function () {
                $(this).select2({
                    width: '100%'
                });
            });
            

            $('.dropify').each(function () {
                var drEvent = $(this).dropify({
                    messages: {
                        'default': 'Selecciona un archivo',
                        'replace': 'Selecciona un archivo para reemplazar',
                        'remove': 'Eliminar',
                        'error': 'Ooops, surgio un problema.'
                    },
                    error: {
                        'fileSize': 'El archivo es muy pesado ({{ value }} max).',
                        'fileExtension': 'Formato de archivo invalido ({{ value }} solamente).'
                    }
                });
                var url = $(this).data("eliminar");
                var id = $(this).data("id");
                if (url != null && id != 0) {
                    drEvent.on('dropify.beforeClear', function (event, element) {
                        var result = confirm("Esta seguro de eliminar la foto ?");
                        if (result) {
                            $("#" + url).prop('checked', true)
                        }
                        else {
                            return false;
                        }
                    });
                }
            });

            $.fn.datepicker.language['es'] = {
                days: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                daysShort: ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'],
                daysMin: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Augosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                monthsShort: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                today: 'Hoy',
                clear: 'Limpiar',
                dateFormat: 'dd/mm/yyyy',
                timeFormat: 'hh:ii aa',
                firstDay: 1
            };

            $('.calendarioSingle').each(function () {

                var destino = $(this).data("destino");

                var picker = $(this).datepicker({
                    todayButton: new Date(),
                    multipleDates: false,
                    onSelect: function (fd, d, picker) {
                        $("#" + destino).val(picker.selectedDates);
                    }
                });

                var fecha = $(this).data("valor");

                if (fecha != "") {
                    picker.data('datepicker').selectDate(new Date(fecha.split("/")[2], fecha.split("/")[1] - 1, fecha.split("/")[0]))
                }
            });

            (function ($) {
                $.fn.datetimepicker.dates['es'] = {
                    days: ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"],
                    daysShort: ["Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb"],
                    daysMin: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "Sa"],
                    months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                    monthsShort: ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"],
                    //format: 'dd/mm/yyyy',
                    meridiem: ''
                };
            }(jQuery));

            $('.dateOnlyPicker').each(function () {
                $(this).datetimepicker({
                    language: 'es',
                    minView: 2,
                    dateonly: true,
                    todayHighlight: !0,
                    autoclose: !0,
                    pickerPosition: "bottom-left",
                    format: "dd/mm/yyyy"
                });
            });

            $('.repeater').each(function () {

                var defaultValues = {
                    'Codigo': "",
                    'IdArticulo': -1,
                    'Cantidad': "1",
                    'UnidadMedida': "unidad",
                    'Precio': "0"
                };

                var repeater = $(this).repeater({

                    initEmpty: $(this).data("empty"),

                    defaultValues: defaultValues,

                    ready: function () {

                    },

                    show: function () {
                        $(this).slideDown();

                        $('.kt-selectpicker').each(function () {
                            var valor = $(this).val();
                            $(this).selectpicker();
                            $(this).val(valor);
                            $(this).selectpicker('refresh');
                        });

                        if($("#Id").val() != 0)
                        {
                        }
                    },

                    hide: function (deleteElement) {
                        $(this).slideUp(deleteElement);
                    }

                });

                var items = $(this).data("items");

                var listado = [];

                var split1 = items.split(';');

                for (var i = 0; i < split1.length; i++) {
                    if (split1 != "") {
                        var split2 = split1[i].split('+');
                        listado.push({
                            'Codigo': split2[0],
                            'IdArticulo': split2[1],
                            'Cantidad': split2[2],
                            'UnidadMedida': split2[3],
                            'Precio': split2[4]
                        });
                    }
                }

                repeater.setList(listado);

            });

            $('[data-toggle="kt-tooltip"]').each(function () {
                initTooltip($(this));
            });

            $('.xeditable').each(function () {

                $(this).editable({
                    mode: 'popup',
                    emptytext: '...',
                    title: 'Editar valor',
                    placement: 'top',
                    inputclass: 'some_class',
                    url: function (params) {

                        debugger;

                        var field = $(this).attr("data-field");
                        var url = $(this).attr("data-urlSend");
                        var pk = $(this).attr("data-pk");

                        $.get(url, { id: pk, valor: params.value, campo: field }, function (data) {
                            debugger;
                            if (data.resultado) {
                                notyf.success(data.mensaje);
                            }
                            else {
                                notyf.error(data.mensaje);
                            }
                        }).fail(function (xhr, status, error) {
                            notyf.error("Oh no!");
                            return;
                        });

                        //return $.ajax({
                        //    dataType: "json",
                        //    type: "post",
                        //    data: JSON.stringify({ id: pk, valor: params.value, campo: field }),
                        //    url: url,
                        //    contentType: 'application/json; charset=utf-8',
                        //    success: function (data) {
                        //        if (data.Resultado) {
                        //            notyf.success(data.Mensaje);
                        //        }
                        //        else {
                        //            notyf.error(data.Mensaje);
                        //        }
                        //    },
                        //    error: function () {
                        //        notyf.error("Oh no!");
                        //    }
                        //});
                    }
                });
            });

            KTApp.unblock('.modal-body');

            $("#btn_modal_nuevo").attr('disabled', false);

        }

        var initTooltip = function (el) {
            var skin = el.data('skin') ? 'tooltip-' + el.data('skin') : '';
            var width = el.data('width') == 'auto' ? 'tooltop-auto-width' : '';
            var triggerValue = el.data('trigger') ? el.data('trigger') : 'hover';
            var placement = el.data('placement') ? el.data('placement') : 'left';

            el.tooltip({
                trigger: triggerValue,
                template: '<div class="tooltip ' + skin + ' ' + width + '" role="tooltip">\
                <div class="arrow"></div>\
                <div class="tooltip-inner"></div>\
            </div>'
            });
        }

        function InitTabla() {

            console.log("InitTabla");

        }

        $('#btn_config').on('click', function (e) {

            KTApp.block('.modal-body', {});

            $("#title_modal_nuevo").html("Configuración de aprobación");
            $("#btn_modal_nuevo").show();

            $.get("/Admin/Negocio", {}, function (result) {

                $('#content_modal_nuevo').html(result);

                InitModal();

                $('#btn_modal_nuevo').unbind('click').click(function (e) {

                    e.preventDefault();

                    var btn = $(this);
                    btn.attr('disabled', true);

                    var form = $(this).closest("form");
                    $.validator.unobtrusive.parse(form[0]);
                    var _data = new FormData(form[0]);

                    if (!form.valid()) {
                        formError(btn, "Algunos datos no son correctos");
                        return;
                    }

                    KTApp.block('.modal-body', {});

                    $.ajax({
                        url: "/Admin/Negocio",
                        type: "POST",
                        data: _data,
                        cache: false,
                        contentType: false,
                        processData: false,
                        success: function (result) {
                            if (result.success) {
                                $('#modal_nuevo').modal('toggle');
                                successMessage(result.message);
                            }
                            else {
                                formError(btn, result.message);
                            }
                            return;
                        },
                        error: function (xhr, textStatus) {
                            formError(btn, "Algunos datos no son correctos");
                            return;
                        }
                    });

                });

            }).fail(function (xhr, status, error) {
                errorMessage("Ups.. Surgio un error inesperado");
                return;
            });

        });

    </script>

    <partial name="~/Views/Shared/_ValidationScriptsPartial.cshtml" />

    <script>
        jQuery(document).ready(function () {
            $.validator.methods.number = function (value, element) {
                return this.optional(element) || /^-?(?:\d+|\d{1,3}(?:\.\d{3})+)?(?:,\d+)?$/.test(value);
            }
        });
    </script>

    @RenderSection("scripts", required: false)

</body>

</html>